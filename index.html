<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POSTUGANG's Eurovision App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1A202C;
            color: #E2E8F0;
            overscroll-behavior-y: contain;
            line-height: 1.6;
        }

        /* Theme Colors */
        .theme-primary { color: #FBBF24; }
        .theme-secondary { color: #60A5FA; }
        .bg-theme-surface { background-color: #2D3748; }
        .border-theme-highlight { border-color: #FBBF24; }

        /* Header Enhancements */
        header {
            background-color: #1F2937; 
            padding: 1.5rem 1rem 2rem; 
            border-bottom: 4px solid #FBBF24; 
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0, 0.2);
        }
        header::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 100 100'%3E%3Cpath d='M50 87.5L46.5 84.4C21.6 62.4 10 52.8 10 38C10 27.2 18.2 19 28.5 19C35.6 19 42.8 23.4 46.5 29.5C48.3153 26.3165 50.5049 23.4017 53.0031 20.8616C55.5012 18.3215 58.2783 16.1989 61.2428 14.5737C64.2073 12.9485 67.3264 11.8421 70.5 11.29C71.5 11.29 71.5 11.29 71.5 11.29C81.8 11.29 90 19.49 90 29.29C90 44.09 78.4 53.69 53.5 75.69L50 78.79Z' fill='%23FBBF24' fill-opacity='0.03'/%3E%3C/svg%3E");
            background-size: 50px 50px; 
            opacity: 0.6;
            z-index: 0;
        }
        header > * { position: relative; z-index: 1; }
        .eurovision-logo-container { display: flex; align-items: center; justify-content: center; margin-bottom: 0.5rem; }
        .eurovision-logo-container svg { width: 3rem; height: 3rem; margin-right: 0.75rem; color: #EF4444; }
        header h1 { color: #FBBF24; font-size: 2.25rem; sm:font-size: 2.5rem; font-weight: 700; }
        header .subtitle { color: #9CA3AF; font-size: 1rem; sm:font-size: 1.1rem; text-transform: uppercase; letter-spacing: 0.075em; margin-top: 0.25rem; }
        header .app-subtitle { color: #60A5FA; font-size: 1.2rem; sm:font-size: 1.3rem; font-weight: 500; margin-top: 0.35rem; }

        /* Tab Buttons */
        .tab-button-container { display: flex; justify-content: center; gap: 0.5rem; sm:gap: 0.75rem; margin-bottom: 1.5rem; }
        .tab-button {
            padding: 0.75rem 1.25rem; 
            border-radius: 0.5rem; 
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s, box-shadow 0.3s, transform 0.2s;
            font-weight: 600;
            border: 1px solid transparent;
            font-size: 0.9rem; sm:font-size: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .tab-button.active {
            background-color: #FBBF24; color: #1A202C;
            box-shadow: 0 3px 6px rgba(251, 191, 36, 0.4);
            transform: translateY(-2px);
        }
        .tab-button:not(.active) { background-color: #4A5568; color: #E2E8F0; }
        .tab-button:not(.active):hover { background-color: #718096; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }

        /* Cards (Voting Items) */
        .card {
            background-color: var(--bg-theme-surface);
            border: 1px solid #4A5568; 
            border-radius: 0.75rem; 
            padding: 1.25rem;
            margin-bottom: 1.25rem; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .card h3 { color: #FBBF24; font-size: 1.2rem; margin-bottom: 0.35rem; }
        .card p, .card label { color: #CBD5E0; font-size: 0.9rem; }
        .card .text-xs { font-size: 0.8rem; } 

        /* Custom Range Slider Styling (Main form) */
        .slider-container { position: relative; margin-top: 0.5rem; margin-bottom: 1.5rem; }
        input[type="range"] { 
            -webkit-appearance: none; appearance: none; 
            width: 100%; 
            height: 16px; /* Increased track height for better hitbox */
            background: #4A5568; /* Default track, fill is applied via JS */
            outline: none; 
            border-radius: 8px; /* Rounded track */
            cursor: pointer; 
            margin: 0; 
            transition: background 0.3s; 
        }
        input[type="range"]::-webkit-slider-thumb { 
            -webkit-appearance: none; appearance: none; 
            width: 24px; /* Thumb size */
            height: 24px; /* Thumb size */
            background: #FBBF24; 
            cursor: grab; 
            border-radius: 50%; 
            border: 4px solid #2D3748; 
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.6); 
            margin-top: -4px; /* Adjust thumb position relative to new track height */
            transition: transform 0.2s; 
        }
        input[type="range"]::-moz-range-thumb { 
            width: 24px; 
            height: 24px; 
            background: #FBBF24; 
            cursor: grab; 
            border-radius: 50%; 
            border: 4px solid #2D3748; 
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.6); 
        }
        input[type="range"]:active::-webkit-slider-thumb { cursor: grabbing; transform: scale(1.1); }
        input[type="range"]:active::-moz-range-thumb { cursor: grabbing; transform: scale(1.1); }
        .slider-ticks { display: flex; justify-content: space-between; padding: 0 5px; margin-top: 0.6rem; }
        .slider-ticks span { font-size: 0.8rem; color: #9CA3AF; position: relative; }
        .slider-ticks span::before { content: ''; position: absolute; left: 50%; transform: translateX(-50%); top: -10px; width: 1.5px; height: 5px; background-color: #718096; }

        /* Modal specific input styles for compactness */
        .modal-body .modal-score-editor { margin-top: 1.5rem; border-top: 1px solid #4A5568; padding-top: 1rem;}
        .modal-body .modal-score-item-editor { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .modal-body .modal-score-item-editor label { font-size: 0.9rem; color: #CBD5E0; flex-basis: 60%;}
        .modal-body .modal-score-item-editor input[type="number"] {
            width: 60px; 
            padding: 0.3rem 0.5rem;
            background-color: #1F2937;
            border: 1px solid #4A5568;
            color: #E2E8F0;
            border-radius: 0.375rem;
            text-align: center;
            font-size: 0.9rem;
            -moz-appearance: textfield; 
        }
        .modal-body .modal-score-item-editor input[type="number"]::-webkit-outer-spin-button,
        .modal-body .modal-score-item-editor input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }


        .score-output { color: #FBBF24; font-weight: bold; font-size: 1.05rem; min-width: 22px; display: inline-block; text-align: right; }
        .total-entry-score { color: #FFFFFF; background-color: #60A5FA; padding: 0.35rem 0.7rem; border-radius: 0.3rem; font-size: 0.95rem; }
        
        /* Leaderboard Table Styles */
        .leaderboard-table-container { overflow-x: auto; background-color: var(--bg-theme-surface); border: 1px solid #4A5568; border-radius: 0.75rem; box-shadow: 0 6px 12px rgba(0,0,0,0.2); }
        .leaderboard-table { width: 100%; border-collapse: collapse; }
        .leaderboard-table th, .leaderboard-table td { padding: 0.85rem 1rem; text-align: left; vertical-align: middle; border-bottom: 1px solid #4A5568; white-space: nowrap; }
        .leaderboard-table th {
            font-family: 'Inter', sans-serif; color: #FBBF24; background-color: #252E3D; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.06em; position: sticky; top: 0; z-index: 10; border-right: 1px solid #4A5568;
        }
        .leaderboard-table th:last-child { border-right: none; }
        .leaderboard-table td { color: #E2E8F0; font-size: 0.9rem; border-right: 1px solid #4A5568; }
        .leaderboard-table td:last-child { border-right: none; }
        .leaderboard-table tr:nth-child(even) td { background-color: #354154; }
        .leaderboard-table tr:last-child td { border-bottom: none; }
        .leaderboard-table tr:hover td { background-color: #4A5568; transition: background-color 0.2s; }
        .leaderboard-table .rank-col { text-align: center; font-weight: bold; width: 8%; color: #FBBF24; }
        .leaderboard-table .country-col { width: 30%; font-weight: 500; }
        .leaderboard-table .artist-song-col { width: 35%; font-size: 0.8em; color: #A0AEC0; }
        .leaderboard-table .score-col { text-align: center; font-weight: bold; font-size: 1em; width: 8%; color: #FBBF24; }
        .leaderboard-table .details-col { text-align: center; width: 19%; }
        .leaderboard-table .details-button { font-size: 0.8em; padding: 0.3rem 0.6rem; min-width: 65px; text-align: center; }

        /* Modal Styling */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.88); 
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; overflow-y: auto; padding: 1rem;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: #2D3748; 
            padding: 0; 
            border-radius: 0.875rem; 
            border: 1px solid #4A5568;
            width: 95%; max-width: 480px; 
            color: #E2E8F0;
            box-shadow: 0 12px 35px rgba(0,0,0,0.5); 
            text-align: left; 
            transform: scale(0.95);
            transition: transform 0.3s ease;
            max-height: 90vh; 
            display: flex;
            flex-direction: column;
        }
        .modal.show .modal-content { transform: scale(1); }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #4A5568;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-shrink: 0;
        }
        .modal-header-content {}
        .modal-country-flag { font-size: 2.5rem; margin-right: 0.75rem; line-height: 1; }
        .modal-country-name {
            color: #FBBF24;
            font-size: 1.6rem; sm:font-size: 1.85rem;
            font-weight: 700;
            line-height: 1.2;
            display: inline;
        }
        .modal-song-artist { margin-top: 0.5rem; }
        .modal-song-title { font-size: 1.1rem; font-weight: 500; color: #CBD5E0; }
        .modal-artist-name { font-size: 0.95rem; color: #9CA3AF; }
        .modal-close-btn {
            background: none; border: none; color: #9CA3AF; font-size: 2.25rem;
            line-height: 1; padding: 0.25rem; cursor: pointer; transition: color 0.2s;
        }
        .modal-close-btn:hover { color: #FBBF24; }

        .modal-body { 
            padding: 1.25rem 1.5rem; 
            overflow-y: auto; 
            flex-grow: 1;
        }
        
        .modal-body .chart-container {
             height: 180px; width: 180px; 
             padding: 0.2rem;
             background-color: transparent; box-shadow: none; margin: 0 auto 1.5rem auto; 
        }


        .modal-footer {
            padding: 0.75rem 1.5rem; 
            border-top: 1px solid #4A5568;
            text-align: right;
            flex-shrink: 0;
        }
        .modal-footer .btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }


        /* Buttons */
        .btn {
            background-color: #FBBF24; color: #1A202C; padding: 0.7rem 1.4rem;
            border-radius: 0.5rem; font-weight: 600; cursor: pointer;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            border: none; font-size: 0.95rem; box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            display: inline-flex; align-items: center; justify-content: center;
        }
        .btn:hover { background-color: #F59E0B; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3); }
        .btn-secondary { background-color: #4A5568; color: #E2E8F0; }
        .btn-secondary:hover { background-color: #718096; box-shadow: 0 4px 8px rgba(113, 128, 150, 0.2); }
        .btn-danger { background-color: #E53E3E; color: #FFFFFF; }
        .btn-danger:hover { background-color: #C53030; box-shadow: 0 4px 8px rgba(229, 62, 62, 0.3); }
        .btn-subtle { background-color: #3E4C5F; color: #A0AEC0; font-size: 0.85rem; padding: 0.5rem 1rem;}
        .btn-subtle.active { background-color: #FBBF24; color: #1A202C; font-weight: 600;} 
        .btn-subtle:not(.active):hover { background-color: #4A5568; color: #E2E8F0; }
        .btn.disabled, .btn:disabled { background-color: #718096; color: #A0AEC0; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }


        /* Chart Container (Main page) */
        .chart-options { margin-bottom: 1rem; display: flex; justify-content: center; align-items: center; gap: 0.75rem; }
        .chart-container { position: relative; margin: auto; height: 280px; width: 100%; background-color: #252E3D; padding: 1rem; border-radius: 0.5rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
        

        /* Exportable Results (Hidden) */
        #exportableResultsContainer { position: fixed; top: -9999px; left: -9999px; opacity: 0; z-index: -1; }
        #exportableResults { width: 375px; padding: 20px; background-color: #1A202C; color: #FBBF24; font-family: 'Inter', sans-serif; border: 2px solid #FBBF24; border-radius: 10px; }
        #exportableResults h2 { text-align: center; font-size: 20px; margin-bottom: 15px; color: #FBBF24; }
        #exportableResults ul { list-style: none; padding: 0; }
        #exportableResults li { background-color: #2D3748; color: #E2E8F0; padding: 8px 12px; margin-bottom: 8px; border-radius: 5px; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
        #exportableResults li .country-info { flex-grow: 1; }
        #exportableResults li .score { font-weight: bold; color: #FBBF24; font-size: 15px; }
        #exportableResults .watermark { font-size: 9px; text-align: center; margin-top: 15px; color: #FBBF24; opacity: 0.7; }

        /* Custom Message Box */
        .custom-message-box { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #FBBF24; color: #1A202C; padding: 12px 20px; border-radius: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 2000; font-weight: 600; font-size: 0.9rem; opacity: 0; transition: opacity 0.3s ease-in-out, bottom 0.3s ease-in-out; pointer-events: none; }
        .custom-message-box.show { opacity: 1; bottom: 30px; pointer-events: auto; }
        

        /* Responsive Adjustments */
        @media (min-width: 640px) { 
            header h1 { font-size: 2.5rem; }
            header .subtitle { font-size: 1.1rem; }
            header .app-subtitle { font-size: 1.3rem; }
            .tab-button { padding: 0.85rem 1.75rem; font-size: 1rem; }
            .card { padding: 1.5rem; }
            .card h3 { font-size: 1.3rem; }
            .card p, .card label { font-size: 0.95rem; }
            .leaderboard-table th { font-size: 0.9rem; }
            .leaderboard-table td { font-size: 0.95rem; }
            .btn { padding: 0.8rem 1.6rem; font-size: 1rem; } 
            .modal-footer .btn { padding: 0.6rem 1.2rem; font-size: 0.9rem; } 
            .chart-container { height: 350px; } 
            .modal-body .chart-container { height: 200px; width: 200px; } 
            .modal-content { padding: 0; }
            .modal-header { padding: 1.5rem 2rem; }
            .modal-body { padding: 1.5rem 2rem; } 
        }
        @media (min-width: 768px) { 
            .chart-container { height: 400px; } 
            .modal-country-name { font-size: 2rem; }
            .modal-song-title { font-size: 1.2rem; }
            .modal-artist-name { font-size: 1rem; }
            .modal-body .chart-container { height: 220px; width: 220px; } 
        }
        
        .leaderboard-table-container::-webkit-scrollbar { display: none; }
        .leaderboard-table-container { -ms-overflow-style: none; scrollbar-width: none; }

    </style>
</head>
<body class="min-h-screen p-0 md:p-4">

    <header class="mb-6 md:mb-8 shadow-lg">
        <div class="eurovision-logo-container">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
            <h1>POSTUGANG's</h1>
        </div>
        <p class="subtitle">Eurovision</p>
        <p class="app-subtitle">Voting System 2025</p>
    </header>

    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 pb-8">
        <div class="tab-button-container mb-8">
            <button id="voteTabButton" class="tab-button active" onclick="showTab('vote')">Vote</button>
            <button id="leaderboardTabButton" class="tab-button" onclick="showTab('leaderboard')">Leaderboard</button>
            <button id="chartsTabButton" class="tab-button" onclick="showTab('charts')">Charts</button>
        </div>

        <div id="voteTab" class="tab-content">
            <div id="votingForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
                </div>
            <div class="mt-8 text-center space-y-3 sm:space-y-0 sm:flex sm:flex-wrap sm:justify-center sm:gap-4">
                <button class="btn w-full sm:w-auto text-lg px-8 py-3" onclick="submitVotes()">Submit All Votes</button>
                <button class="btn btn-danger w-full sm:w-auto text-lg px-8 py-3" onclick="resetAllVotes()">Reset All Votes</button>
            </div>
        </div>

        <div id="leaderboardTab" class="tab-content hidden">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 sm:mb-6">
                <h2 class="text-2xl sm:text-3xl font-semibold text-center sm:text-left theme-primary mb-3 sm:mb-0">Leaderboard</h2>
            </div>
            <div class="leaderboard-table-container"> 
                <table id="leaderboardTable" class="min-w-full leaderboard-table">
                    <thead>
                        <tr>
                            <th class="rank-col">Rank</th>
                            <th class="country-col">Country</th>
                            <th class="score-col">Score</th>
                            <th class="details-col">Votes</th>
                            <th class="artist-song-col">Artist - Song</th> 
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

        <div id="chartsTab" class="tab-content hidden">
            <h2 class="text-2xl sm:text-3xl font-semibold mb-2 text-center theme-primary">Results Visualisation</h2>
            <div class="chart-options mb-6">
                <span class="text-sm text-gray-400">Display:</span>
                <button id="chartDisplayAllButton" class="btn btn-subtle" onclick="setChartDisplayMode('all')">All Scores</button>
                <button id="chartDisplayTop10Button" class="btn btn-subtle active" onclick="setChartDisplayMode('top10')">Top 10</button>
            </div>
            <div class="bg-theme-surface p-3 sm:p-4 rounded-lg border border-theme-highlight shadow-lg mb-6">
                <div class="chart-container mx-auto"> 
                    <canvas id="totalScoresChart"></canvas>
                </div>
            </div>
             <div class="mt-6 text-center space-y-3 sm:space-y-0 sm:flex sm:flex-wrap sm:justify-center sm:gap-4">
                <button class="btn w-full sm:w-auto" onclick="exportResultsSummary()">Export Text Summary</button>
                <button class="btn w-full sm:w-auto" onclick="exportResultsAsImage()">Export as Image</button>
            </div>
        </div>
    </div>

    <div id="scoreBreakdownModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-content">
                    <h3 class="flex items-center">
                        <span id="modalCountryFlag" class="modal-country-flag"></span>
                        <span id="modalCountryName" class="modal-country-name"></span>
                    </h3>
                    <div id="modalSongArtistInfo" class="modal-song-artist">
                        <p id="modalSongTitle" class="modal-song-title"></p>
                        <p id="modalArtistName" class="modal-artist-name"></p>
                    </div>
                </div>
                <button class="modal-close-btn" onclick="closeModal('scoreBreakdownModal')" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modalScore_countryId_temp" data-countryid=""></div> 
                <div class="chart-container mx-auto"> 
                    <canvas id="categoryBreakdownChart"></canvas>
                </div>
                <div id="modalScoreEditor" class="modal-score-editor">
                    </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary mr-2" onclick="closeModal('scoreBreakdownModal')">Cancel</button>
                <button id="updateVotesFromModalButton" class="btn" onclick="updateVotesFromModal()" disabled>Update Votes</button>
            </div>
        </div>
    </div>

    <div id="exportableResultsContainer">
        <div id="exportableResults">
            <h2 class="theme-primary">POSTUGANG's Eurovision Results</h2>
            <ul id="exportableResultsList"></ul>
            <p class="watermark">Generated by POSTUGANG's Eurovision App</p>
        </div>
    </div>
    <div id="customMessageBox" class="custom-message-box"></div>

    <script>
        // Eurovision 2025 Entries (Sample Data)
        const entries = [
            { id: 1, country: "Norway", artist: "KYLE ALESSANDRO", song: "Lighter", flag: "ðŸ‡³ðŸ‡´" },
            { id: 2, country: "Luxembourg", artist: "LAURA THORN", song: "La PoupÃ©e Mante Le Son", flag: "ðŸ‡±ðŸ‡º" },
            { id: 3, country: "Estonia", artist: "TOMMY CASH", song: "Espresso Macchiato", flag: "ðŸ‡ªðŸ‡ª" },
            { id: 4, country: "Israel", artist: "YUVAL RAPHAEL", song: "New day will Rise", flag: "ðŸ‡®ðŸ‡±" },
            { id: 5, country: "Lithuania", artist: "KATARSIS", song: "Tavo Akys", flag: "ðŸ‡±ðŸ‡¹" },
            { id: 6, country: "Spain", artist: "MELODY", song: "Esa Diva", flag: "ðŸ‡ªðŸ‡¸" },
            { id: 7, country: "Ukraine", artist: "ZIFERBLAT", song: "Bird of Pray", flag: "ðŸ‡ºðŸ‡¦" },
            { id: 8, country: "United Kingdom", artist: "REMEMBER MONDAY", song: "What the Hell pust Happened?", flag: "ðŸ‡¬ðŸ‡§" },
            { id: 9, country: "Austria", artist: "Ù„Ø§ (Artist Name)", song: "Wasted Love", flag: "ðŸ‡¦ðŸ‡¹" },
            { id: 10, country: "Iceland", artist: "VAEB", song: "Ron", flag: "ðŸ‡®ðŸ‡¸" },
            { id: 11, country: "Latvia", artist: "TAUTUMEITAS", song: "Bur Man Laimi", flag: "ðŸ‡±ðŸ‡»" },
            { id: 12, country: "Netherlands", artist: "CLAUDE", song: "C'est Lo Vie", flag: "ðŸ‡³ðŸ‡±" },
            { id: 13, country: "Finland", artist: "ERIKA VIKMAN", song: "Ãch Komme", flag: "ðŸ‡«ðŸ‡®" },
            { id: 14, country: "Italy", artist: "LUCIO CORSI", song: "Volevo Essere un Duro", flag: "ðŸ‡®ðŸ‡¹" },
            { id: 15, country: "Poland", artist: "JUSTYNA", song: "Gaja", flag: "ðŸ‡µðŸ‡±" },
            { id: 16, country: "Germany", artist: "ABOR & TÎ¥ÎÎÎ‘", song: "Baller", flag: "ðŸ‡©ðŸ‡ª" },
            { id: 17, country: "Greece", artist: "KLAVDIA", song: "AsteramÃ³ta", flag: "ðŸ‡¬ðŸ‡·" },
            { id: 18, country: "Armenia", artist: "PARG", song: "Survivor", flag: "ðŸ‡¦ðŸ‡²" },
            { id: 19, country: "Switzerland", artist: "ZOÃ‹ MÃ‹", song: "Voyage", flag: "ðŸ‡¨ðŸ‡­" },
            { id: 20, country: "Malta", artist: "MIRIANA CONTE", song: "Serving", flag: "ðŸ‡²ðŸ‡¹" },
            { id: 21, country: "Portugal", artist: "NAPA", song: "Deslocado", flag: "ðŸ‡µðŸ‡¹" },
            { id: 22, country: "Denmark", artist: "SISSAL", song: "Hallucination", flag: "ðŸ‡©ðŸ‡°" },
            { id: 23, country: "Sweden", artist: "KAJ", song: "Bara Bado Bostu", flag: "ðŸ‡¸ðŸ‡ª" },
            { id: 24, country: "France", artist: "LOUANE", song: "Maman", flag: "ðŸ‡«ðŸ‡·" },
            { id: 25, country: "San Marino", artist: "GABRY PONTE", song: "Tutto l'italia", flag: "ðŸ‡¸ðŸ‡²" },
            { id: 26, country: "Albania", artist: "SHKODRA ELEKTRONIKE", song: "Zierm", flag: "ðŸ‡¦ðŸ‡±" }
        ];

        // Categories for display and input order
        const displayCategories = [
            { id: 'song', name: 'Song', short: 'S', maxPoints: 3 },
            { id: 'artist', name: 'Artist', short: 'A', maxPoints: 3 },
            { id: 'performance', name: 'Performance', short: 'P', maxPoints: 3 },
            { id: 'overall', name: 'Overall', short: 'O', maxPoints: 3 }
        ];

        // Categories for tie-breaking logic (Overall first) and potentially for chart stacking order
        const tieBreakAndChartCategories = [
            { id: 'overall', name: 'Overall', short: 'O', maxPoints: 3 },
            { id: 'song', name: 'Song', short: 'S', maxPoints: 3 },
            { id: 'performance', name: 'Performance', short: 'P', maxPoints: 3 },
            { id: 'artist', name: 'Artist', short: 'A', maxPoints: 3 }
        ];


        let votes = {}; 
        let totalScoresChartInstance = null;
        let categoryBreakdownChartInstance = null;
        let votesChangedSinceLastSave = false;
        let currentChartDisplayMode = 'top10'; // Default to Top 10
        let modalVotesChanged = false; 
        let tempModalScores = {}; 

        const doughnutTextPlugin = {
            id: 'doughnutText',
            afterDraw(chart, args, options) {
                if (options.text) {
                    const { ctx, chartArea: { width, height } } = chart;
                    ctx.save();
                    const x = width / 2;
                    const y = height / 2;
                    ctx.font = options.font || 'bold 28px Inter';
                    ctx.fillStyle = options.color || '#FBBF24';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(options.text, x, y + (options.textOffsetY || -10));
                    if (options.subText) {
                        ctx.font = options.subTextFont || 'normal 12px Inter';
                        ctx.fillStyle = options.subTextColor || '#CBD5E0';
                        ctx.fillText(options.subText, x, y + (options.subTextOffsetY || 15));
                    }
                    ctx.restore();
                }
            }
        };
        Chart.register(doughnutTextPlugin);

        function showCustomMessage(message, duration = 3000) {
            const messageBox = document.getElementById('customMessageBox');
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => { messageBox.classList.remove('show'); }, duration);
        }

        function updateSliderVisual(slider) {
            if (!slider || slider.type !== 'range') return;
            const min = parseFloat(slider.min);
            const max = parseFloat(slider.max);
            const value = parseFloat(slider.value);
            const percentage = ((value - min) / (max - min)) * 100;
            const fillPercentage = Math.max(0.1, percentage); 
            slider.style.background = `linear-gradient(to right, #FBBF24 ${fillPercentage}%, #4A5568 ${fillPercentage}%)`;
        }
        
        function createCategoryInputHTML(entryId, category, currentValue, isModal = false) {
            const inputId = `cat-input-${category.id}-${isModal ? 'modal-' : ''}${entryId}`;
            const valueDisplayId = `val-display-${category.id}-${isModal ? 'modal-' : ''}${entryId}`; // Only used for sliders

            if (isModal) {
                return `
                    <div class="modal-score-item-editor">
                        <label for="${inputId}" class="block text-sm font-medium">${category.name} (0-${category.maxPoints} pts)</label>
                        <input type="number" id="${inputId}" name="${inputId}" 
                               min="0" max="${category.maxPoints}" value="${currentValue}"
                               oninput="updateScoreDisplayInModal(${entryId}, '${category.id}', this.value)"
                               onchange="updateScoreDisplayInModal(${entryId}, '${category.id}', this.value)" 
                               class="w-16 p-1 text-center bg-gray-700 border border-gray-600 rounded">
                    </div>`;
            } else { // Slider for main voting form
                return `
                    <div class="modal-score-item"> 
                        <div class="flex justify-between items-center mb-1">
                            <label for="${inputId}" class="block text-sm font-medium">${category.name} (0-${category.maxPoints} pts)</label>
                            <span id="${valueDisplayId}" class="score-output">${currentValue}</span>
                        </div>
                        <div class="slider-container">
                            <input type="range" id="${inputId}" name="${inputId}" 
                                   min="0" max="${category.maxPoints}" value="${currentValue}" step="1"
                                   oninput="updateScoreDisplay(${entryId}, '${category.id}', this.value, this, '${valueDisplayId}')"
                                   onclick="handleSliderTrackClick(event, ${entryId}, '${category.id}', this, '${valueDisplayId}')"
                                   aria-labelledby="label-${inputId}">
                            <div class="slider-ticks">
                                ${Array.from({ length: category.maxPoints + 1 }, (_, i) => `<span>${i}</span>`).join('')}
                            </div>
                        </div>
                    </div>`;
            }
        }

        function handleSliderTrackClick(event, countryId, categoryId, slider, valueDisplayId) {
            // Only proceed if the click was not on the thumb itself (which is handled by 'input' event)
            if (event.target !== slider) return; 

            const rect = slider.getBoundingClientRect();
            const offsetX = event.clientX - rect.left;
            const percentage = offsetX / rect.width;
            let value = parseFloat(slider.min) + percentage * (parseFloat(slider.max) - parseFloat(slider.min));
            value = Math.round(value / parseFloat(slider.step)) * parseFloat(slider.step);
            
            // Clamp value within min/max
            value = Math.max(parseFloat(slider.min), Math.min(value, parseFloat(slider.max)));

            if (parseFloat(slider.value) !== value) {
                slider.value = value;
                // Manually trigger the input event to ensure all updates occur
                updateScoreDisplay(countryId, categoryId, slider.value, slider, valueDisplayId);
            }
        }


        function initVotingForm() {
            const votingForm = document.getElementById('votingForm');
            votingForm.innerHTML = ''; 
            entries.forEach(entry => {
                const card = document.createElement('div');
                card.className = 'card';
                const currentEntryVotes = votes[entry.id] || {};
                let categoryHTML = '';
                displayCategories.forEach(cat => { // Use displayCategories for order
                    const currentValue = currentEntryVotes[cat.id] || 0;
                    categoryHTML += createCategoryInputHTML(entry.id, cat, currentValue, false);
                });

                card.innerHTML = `
                    <h3 class="text-lg font-semibold mb-1">${entry.flag} ${entry.country}</h3>
                    <p class="text-xs text-gray-400 mb-4">${entry.artist} - "${entry.song}"</p>
                    ${categoryHTML}
                    <div class="mt-4 text-right">
                        <strong class="text-md">Total: <span id="total-${entry.id}" class="total-entry-score">0</span> / ${displayCategories.reduce((sum, cat) => sum + cat.maxPoints, 0)} pts</strong>
                    </div>`;
                votingForm.appendChild(card);
                displayCategories.forEach(cat => {
                    const slider = card.querySelector(`#cat-input-${cat.id}-${entry.id}`);
                    if (slider && slider.type === 'range') updateSliderVisual(slider);
                });
                updateEntryTotal(entry.id); 
            });
        }

        function updateScoreDisplay(countryId, categoryId, value, sliderElement, valueDisplayId) {
            document.getElementById(valueDisplayId).textContent = value;
            
            if (!votes[countryId]) votes[countryId] = {};
            votes[countryId][categoryId] = parseInt(value);
            updateEntryTotal(countryId); 
            votesChangedSinceLastSave = true;
            
            if (sliderElement && sliderElement.type === 'range') updateSliderVisual(sliderElement);
        }

        function updateScoreDisplayInModal(countryId, categoryId, value) {
            const numericValue = parseInt(value);
            const categoryInfo = displayCategories.find(c => c.id === categoryId); // Use displayCategories
            if (!categoryInfo) return;
            const maxPoints = categoryInfo.maxPoints;

            let clampedValue = isNaN(numericValue) ? 0 : Math.max(0, Math.min(numericValue, maxPoints));
            
            const inputElement = document.getElementById(`cat-input-${categoryId}-modal-${countryId}`);
            if (inputElement && parseInt(inputElement.value) !== clampedValue) {
                 inputElement.value = clampedValue; 
            }

            if (!tempModalScores[countryId]) tempModalScores[countryId] = {};
            if (tempModalScores[countryId][categoryId] !== clampedValue) {
                tempModalScores[countryId][categoryId] = clampedValue;
                modalVotesChanged = true;
                document.getElementById('updateVotesFromModalButton').disabled = false;
            }

            if (categoryBreakdownChartInstance) {
                let totalForDoughnut = 0;
                categoryBreakdownChartInstance.data.datasets[0].data = displayCategories.map(cat => { // Use displayCategories
                    const score = tempModalScores[countryId][cat.id] || 0;
                    totalForDoughnut += score;
                    return score;
                });
                categoryBreakdownChartInstance.options.plugins.doughnutText.text = totalForDoughnut.toString();
                categoryBreakdownChartInstance.update('none'); 
            }
        }
        
        function updateEntryTotal(countryId, specificVotes) {
            let total = 0;
            const currentVotesToCalc = specificVotes || votes[countryId]; 
            if (currentVotesToCalc) {
                displayCategories.forEach(cat => { total += currentVotesToCalc[cat.id] || 0; }); // Use displayCategories for sum
            }
            const totalElement = document.getElementById(`total-${countryId}`); 
            if (totalElement) totalElement.textContent = total;
            return total;
        }

        function saveVotes() {
            localStorage.setItem('eurovisionVotesPostugangApp', JSON.stringify(votes));
            votesChangedSinceLastSave = false;
        }

        function loadVotesAndInitializeForm() {
            const savedVotes = localStorage.getItem('eurovisionVotesPostugangApp');
            if (savedVotes) votes = JSON.parse(savedVotes);
            else votes = {};
            initVotingForm();
            votesChangedSinceLastSave = false;
        }
        
        function submitVotes() {
            saveVotes(); 
            showCustomMessage('Votes Submitted! Results updated.');
            updateLeaderboard();
            updateCharts(); // Will use currentChartDisplayMode, which defaults to top10
            showTab('leaderboard'); 
        }

        function resetAllVotes() {
            if (confirm("Are you sure you want to reset all votes? This action cannot be undone.")) {
                votes = {}; 
                localStorage.removeItem('eurovisionVotesPostugangApp');
                initVotingForm(); 
                updateLeaderboard(); 
                setChartDisplayMode('top10'); // Reset chart to top10 on reset
                votesChangedSinceLastSave = false;
                showCustomMessage('All votes have been reset.');
                showTab('vote');
            }
        }

        function calculateTotalScores() {
            let ranked = entries.map(entry => {
                let totalScore = 0;
                let breakdown = {};
                displayCategories.forEach(cat => { // Use displayCategories for calculating total and initial breakdown
                    const score = (votes[entry.id] && votes[entry.id][cat.id] !== undefined) ? votes[entry.id][cat.id] : 0;
                    totalScore += score;
                    breakdown[cat.id] = score;
                });
                return { ...entry, totalScore, breakdown };
            });

            ranked.sort((a, b) => {
                if (b.totalScore !== a.totalScore) {
                    return b.totalScore - a.totalScore;
                }
                // Tie-breaking by category scores using tieBreakAndChartCategories order
                for (const category of tieBreakAndChartCategories) { 
                    const scoreA = a.breakdown[category.id] || 0; // Breakdown already has all keys from displayCategories
                    const scoreB = b.breakdown[category.id] || 0;
                    if (scoreB !== scoreA) {
                        return scoreB - scoreA;
                    }
                }
                return a.country.localeCompare(b.country);
            });
            return ranked;
        }
        
        function updateLeaderboard() {
            const leaderboardBody = document.getElementById('leaderboardTable').getElementsByTagName('tbody')[0];
            leaderboardBody.innerHTML = ''; 
            const rankedScores = calculateTotalScores(); 
            if (rankedScores.length === 0 || rankedScores.every(e => e.totalScore === 0 && Object.values(e.breakdown).every(s => s === 0) )) {
                const row = leaderboardBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 5;
                cell.textContent = "No votes submitted yet, or all votes are zero.";
                cell.className = "text-center py-4 theme-primary opacity-75";
                return;
            }
            rankedScores.forEach((entry, index) => {
                const row = leaderboardBody.insertRow();
                // Details button text should reflect displayCategories order
                const voteBreakdownString = displayCategories.map(cat => (entry.breakdown[cat.id] || 0)).join('-');
                row.innerHTML = `
                    <td class="rank-col">${index + 1}</td>
                    <td class="country-col">${entry.flag} ${entry.country}</td>
                    <td class="score-col">${entry.totalScore}</td>
                    <td class="details-col">
                        <button class="btn btn-secondary details-button" onclick="showScoreBreakdown(${entry.id})">
                            ${voteBreakdownString}
                        </button>
                    </td>
                    <td class="artist-song-col">${entry.artist} - "${entry.song}"</td>`;
            });
        }
        
        function setChartDisplayMode(mode) {
            currentChartDisplayMode = mode;
            document.getElementById('chartDisplayAllButton').classList.toggle('active', mode === 'all');
            document.getElementById('chartDisplayTop10Button').classList.toggle('active', mode === 'top10');
            updateCharts();
        }

        function updateCharts() {
            const allRankedScores = calculateTotalScores(); 
            let chartableScores = [];

            if (currentChartDisplayMode === 'top10') {
                chartableScores = allRankedScores.slice(0, 10);
                // If top 10 are all zero but other scores exist, show those instead, up to 10
                if (chartableScores.every(e => e.totalScore === 0) && allRankedScores.some(e => e.totalScore > 0)) {
                    chartableScores = allRankedScores.filter(e => e.totalScore > 0).slice(0, 10);
                }
            } else { // 'all'
                 chartableScores = allRankedScores;
            }
            // Filter out zero scores only if there are actual votes, to avoid empty chart on initial load
            if (Object.keys(votes).length > 0) {
                chartableScores = chartableScores.filter(e => e.totalScore > 0);
            }
            
            const labels = chartableScores.map(e => `${e.flag} ${e.country.substring(0,12)}${e.country.length > 12 ? '...' : ''}`);
            const categoryChartColors = { song: 'rgba(251, 191, 36, 0.8)', artist: 'rgba(96, 165, 250, 0.8)', performance: 'rgba(248, 113, 113, 0.8)', overall: 'rgba(52, 211, 153, 0.8)' };
            const categoryChartBorderColor = '#1A202C';
            // Datasets for stacked bar chart should use tieBreakAndChartCategories for consistent stacking order if desired,
            // or displayCategories if stacking should match input order. Let's use displayCategories for visual consistency with input.
            const datasets = displayCategories.map(cat => ({ 
                label: cat.name, 
                data: chartableScores.map(entry => entry.breakdown[cat.id] || 0), 
                backgroundColor: categoryChartColors[cat.id], 
                borderColor: categoryChartBorderColor, 
                borderWidth: 1, 
                borderRadius: 4 
            }));
            
            const ctx = document.getElementById('totalScoresChart').getContext('2d');
            if (totalScoresChartInstance) totalScoresChartInstance.destroy();
            
            if (labels.length === 0) { // Handles case where no scores are > 0 or no votes yet
                 ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                 ctx.save();
                 ctx.textAlign = 'center';
                 ctx.textBaseline = 'middle';
                 ctx.font = '16px Inter';
                 ctx.fillStyle = '#9CA3AF';
                 ctx.fillText(Object.keys(votes).length === 0 ? 'No votes submitted yet.' : 'No scores above zero to display.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                 ctx.restore();
                 return;
            }

            totalScoresChartInstance = new Chart(ctx, {
                type: 'bar', data: { labels: labels, datasets: datasets },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', 
                    scales: { 
                        x: { stacked: true, beginAtZero: true, ticks: { color: '#A0AEC0', font: { weight: '500' } }, grid: { color: 'rgba(160, 174, 192, 0.15)'} }, 
                        y: { stacked: true, ticks: { color: '#CBD5E0', font: {size: 10, weight: '500'} }, grid: { display: false } } 
                    },
                    plugins: { 
                        legend: { display: true, position: 'bottom', labels: { color: '#A0AEC0', font: {size: 11, weight: '500'}, padding: 15, boxWidth: 12, usePointStyle: true, pointStyle: 'rectRounded' } },
                        tooltip: { backgroundColor: 'rgba(26, 32, 44, 0.9)', titleColor: '#FBBF24', bodyColor: '#E2E8F0', borderColor: '#4A5568', borderWidth: 1, padding: 10, callbacks: { label: context => `${context.dataset.label || ''}: ${context.parsed.x} pts`, footer: tooltipItems => { let sum = 0; if (tooltipItems.length > 0) { const dataIndex = tooltipItems[0].dataIndex; totalScoresChartInstance.data.datasets.forEach(dataset => { sum += dataset.data[dataIndex] || 0; }); } return 'Total: ' + sum + ' pts'; } } } 
                    } 
                }
            });
        }
        
        function showScoreBreakdown(countryId) {
            const entry = entries.find(e => e.id === countryId);
            if (!entry) return;
            
            document.getElementById('modalScore_countryId_temp').dataset.countryid = countryId; 
            modalVotesChanged = false; 
            document.getElementById('updateVotesFromModalButton').disabled = true; 

            tempModalScores[countryId] = JSON.parse(JSON.stringify(votes[countryId] || {}));
            displayCategories.forEach(cat => { // Use displayCategories
                if (tempModalScores[countryId][cat.id] === undefined) {
                    tempModalScores[countryId][cat.id] = 0;
                }
            });

            document.getElementById('modalCountryFlag').textContent = entry.flag;
            document.getElementById('modalCountryName').textContent = entry.country;
            document.getElementById('modalSongTitle').textContent = `"${entry.song}"`;
            document.getElementById('modalArtistName').textContent = entry.artist;
            
            const scoreEditorDiv = document.getElementById('modalScoreEditor');
            scoreEditorDiv.innerHTML = ''; 
            let categoryInputsHTML = '';
            displayCategories.forEach(cat => { // Use displayCategories for order in modal
                const currentValue = tempModalScores[countryId][cat.id] || 0;
                categoryInputsHTML += createCategoryInputHTML(countryId, cat, currentValue, true);
            });
            scoreEditorDiv.innerHTML = categoryInputsHTML;
            
            let totalScoreForEntry = 0;
            displayCategories.forEach(cat => { totalScoreForEntry += (tempModalScores[countryId][cat.id] || 0); });

            const modal = document.getElementById('scoreBreakdownModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';

            setTimeout(() => { 
                const catCtx = document.getElementById('categoryBreakdownChart').getContext('2d');
                if (!catCtx) { console.error("Category breakdown chart context not found!"); return; }
                
                const catLabels = displayCategories.map(c => c.name); // Use displayCategories for chart labels
                const catData = displayCategories.map(c => tempModalScores[countryId][c.id] || 0); // Use displayCategories for data
                const categoryChartColorsModal = { song: 'rgba(251, 191, 36, 0.9)', artist: 'rgba(96, 165, 250, 0.9)', performance: 'rgba(248, 113, 113, 0.9)', overall: 'rgba(52, 211, 153, 0.9)' };
                const doughnutColors = displayCategories.map(cat => categoryChartColorsModal[cat.id]);

                if (categoryBreakdownChartInstance) categoryBreakdownChartInstance.destroy();
                categoryBreakdownChartInstance = new Chart(catCtx, {
                    type: 'doughnut',
                    data: { labels: catLabels, datasets: [{ label: 'Points by Category', data: catData, backgroundColor: doughnutColors, borderColor: '#2D3748', borderWidth: 4, hoverOffset: 8 }] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '65%',
                        plugins: {
                            legend: { display: true, position: 'bottom', labels: { color: '#A0AEC0', font: {size: 9}, padding: 8, boxWidth: 8, usePointStyle: true, pointStyle: 'rectRounded' } }, 
                            tooltip: { enabled: true, backgroundColor: 'rgba(26, 32, 44, 0.9)', titleColor: '#FBBF24', bodyColor: '#E2E8F0', callbacks: { label: context => `${context.label || ''}: ${context.parsed} pts` } },
                            doughnutText: { text: totalScoreForEntry.toString(), font: 'bold 24px Inter', color: '#FBBF24', textOffsetY: -6, subText: 'Total Pts', subTextFont: 'normal 10px Inter', subTextColor: '#A0AEC0', subTextOffsetY: 12 } 
                        }
                    }
                });
            }, 50);
        }
        
        function updateVotesFromModal() {
            const countryId = parseInt(document.getElementById('modalScore_countryId_temp').dataset.countryid);
            if (!countryId || !entries.find(e => e.id === countryId) || !modalVotesChanged) return;

            if (!votes[countryId]) votes[countryId] = {};
            
            displayCategories.forEach(cat => { // Use displayCategories
                votes[countryId][cat.id] = tempModalScores[countryId][cat.id] || 0;
            });

            saveVotes(); 
            initVotingForm(); 
            updateLeaderboard();
            updateCharts();
            
            modalVotesChanged = false;
            document.getElementById('updateVotesFromModalButton').disabled = true;

            showCustomMessage('Votes updated from details!');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('show');
            if (modalId === 'scoreBreakdownModal') {
                if (categoryBreakdownChartInstance) {
                    categoryBreakdownChartInstance.destroy();
                    categoryBreakdownChartInstance = null;
                }
                modalVotesChanged = false; 
                tempModalScores = {}; 
                const updateButton = document.getElementById('updateVotesFromModalButton');
                if (updateButton) updateButton.disabled = true;
            }
            
            const anyModalOpen = document.querySelector('.modal.show');
            if (!anyModalOpen) {
                document.body.style.overflow = 'auto';
            }
        }
        document.addEventListener('keydown', event => { 
            if (event.key === 'Escape') {
                if (document.getElementById('scoreBreakdownModal').classList.contains('show')) closeModal('scoreBreakdownModal');
            }
        });

        function showTab(tabName) {
            ['vote', 'leaderboard', 'charts'].forEach(tabId => { 
                document.getElementById(tabId + 'Tab').classList.add('hidden'); 
                document.getElementById(tabId + 'TabButton').classList.remove('active'); 
            });
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            document.getElementById(tabName + 'TabButton').classList.add('active');
            
            if (tabName !== 'vote') { 
                 if (votesChangedSinceLastSave) saveVotes(); 
            }
            if (tabName === 'leaderboard') updateLeaderboard();
            if (tabName === 'charts') { 
                setChartDisplayMode(currentChartDisplayMode); // Ensures correct button highlight and chart
            }
        }
        
        function exportResultsSummary() {
            const rankedScores = calculateTotalScores();
            if (rankedScores.length === 0 || rankedScores.every(e => e.totalScore === 0)) { showCustomMessage("No scores to export yet!"); return; }
            let summary = "POSTUGANG's Eurovision App Results:\n\n";
            rankedScores.forEach((entry, index) => { summary += `${index + 1}. ${entry.flag} ${entry.country} (${entry.artist} - "${entry.song}"): ${entry.totalScore} points\n`; if (entry.breakdown) { displayCategories.forEach(cat => { summary += `  - ${cat.name}: ${entry.breakdown[cat.id] || 0} pts\n`; }); } summary += "\n"; }); // Use displayCategories for summary
            if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(summary).then(() => showCustomMessage('Results summary copied!')).catch(err => fallbackCopyTextToClipboard(summary)); } else { fallbackCopyTextToClipboard(summary); }
        }

        function fallbackCopyTextToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text; textarea.style.position = 'fixed'; textarea.style.left = '-9999px';
            document.body.appendChild(textarea); textarea.focus(); textarea.select();
            try { document.execCommand('copy'); showCustomMessage('Results summary copied!'); } 
            catch (err) { showCustomMessage('Failed to copy.', 'error'); }
            document.body.removeChild(textarea);
        }

        async function exportResultsAsImage() {
            const rankedScores = calculateTotalScores();
            if (rankedScores.length === 0 || rankedScores.every(e => e.totalScore === 0)) { showCustomMessage("No scores to export as image!"); return; }
            const exportList = document.getElementById('exportableResultsList');
            exportList.innerHTML = ''; 
            const topN = Math.min(rankedScores.length, 12);
            for (let i = 0; i < topN; i++) { const entry = rankedScores[i]; if (entry.totalScore === 0 && i > 5 && Object.keys(votes).length > 0) continue; const listItem = document.createElement('li'); listItem.innerHTML = `<span class="country-info">${i+1}. ${entry.flag} ${entry.country}</span><span class="score">${entry.totalScore} pts</span>`; exportList.appendChild(listItem); }
            if (exportList.children.length === 0) exportList.innerHTML = '<li>No scores to display.</li>';
            const exportableDivContainer = document.getElementById('exportableResultsContainer');
            const exportableDiv = document.getElementById('exportableResults');
            exportableDivContainer.style.opacity = '1'; exportableDivContainer.style.top = '0px'; exportableDivContainer.style.left = '0px'; exportableDivContainer.style.zIndex = '2000'; exportableDiv.style.display = 'block';
            showCustomMessage('Generating image...', 1500);
            try { await new Promise(resolve => setTimeout(resolve, 100)); const canvas = await html2canvas(exportableDiv, { backgroundColor: '#1A202C', scale: 2, useCORS: true, logging: false }); const imageURL = canvas.toDataURL('image/png'); const downloadLink = document.createElement('a'); downloadLink.href = imageURL; downloadLink.download = 'POSTUGANG_Eurovision_Results.png'; document.body.appendChild(downloadLink); downloadLink.click(); document.body.removeChild(downloadLink); showCustomMessage('Image downloaded!', 'success'); }
            catch (error) { console.error("Error generating image:", error); showCustomMessage("Error generating image. See console.", 'error'); }
            finally { exportableDivContainer.style.opacity = '0'; exportableDivContainer.style.top = '-9999px'; exportableDivContainer.style.left = '-9999px'; exportableDivContainer.style.zIndex = '-1'; }
        }

        window.addEventListener('beforeunload', function (e) {
            if (votesChangedSinceLastSave || modalVotesChanged) { 
                e.preventDefault(); e.returnValue = ''; return '';
            }
        });

        window.onload = function() {
            loadVotesAndInitializeForm(); 
            updateLeaderboard();
            setChartDisplayMode('top10'); // Default to Top 10 and highlight button
            showTab('vote'); // Start on vote tab
        };
    </script>
</body>
</html>
